generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  user
  admin
}

enum UserStatus {
  active
  suspended
}

enum BookingStatus {
  pending_payment
  confirmed
  cancelled
  completed
}

enum PaymentStatus {
  pending
  paid
  refunded
  failed
}

enum PaymentProvider {
  stripe
  paypal
  cash
}

// ==================== MODELS ====================

model User {
  id           String     @id @default(uuid())
  name         String     @db.VarChar(100)
  email        String     @unique @db.VarChar(255)
  phone        String?    @db.VarChar(20)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  role         UserRole   @default(user)
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  bookings      Booking[]
  reviews       Review[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Hotel {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(200)
  city        String   @db.VarChar(100)
  address     String   @db.VarChar(500)
  description String   @db.Text
  rating      Decimal  @default(0) @db.Decimal(2, 1)
  lat         Decimal  @db.Decimal(10, 8)
  lng         Decimal  @db.Decimal(11, 8)
  mainImage   String   @map("main_image") @db.VarChar(500)
  priceFrom   Decimal  @map("price_from") @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  images    HotelImage[]
  amenities HotelAmenity[]
  rooms     Room[]
  bookings  Booking[]
  reviews   Review[]

  @@index([city])
  @@index([rating])
  @@index([priceFrom])
  @@index([createdAt])
  @@map("hotels")
}

model HotelImage {
  id       String @id @default(uuid())
  hotelId  String @map("hotel_id")
  imageUrl String @map("image_url") @db.VarChar(500)
  order    Int    @default(0)

  hotel Hotel @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@index([hotelId])
  @@map("hotel_images")
}

model Amenity {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(100)
  icon String @db.VarChar(50)

  hotels HotelAmenity[]

  @@map("amenities")
}

model HotelAmenity {
  hotelId   String @map("hotel_id")
  amenityId String @map("amenity_id")

  hotel   Hotel   @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  amenity Amenity @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([hotelId, amenityId])
  @@map("hotel_amenities")
}

model Room {
  id            String   @id @default(uuid())
  hotelId       String   @map("hotel_id")
  name          String   @db.VarChar(100)
  roomType      String   @map("room_type") @db.VarChar(50)
  description   String   @db.Text
  capacity      Int
  pricePerNight Decimal  @map("price_per_night") @db.Decimal(10, 2)
  totalRooms    Int      @map("total_rooms")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  hotel    Hotel       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  images   RoomImage[]
  bookings Booking[]

  @@index([hotelId])
  @@index([roomType])
  @@index([pricePerNight])
  @@index([capacity])
  @@map("rooms")
}

model RoomImage {
  id       String @id @default(uuid())
  roomId   String @map("room_id")
  imageUrl String @map("image_url") @db.VarChar(500)
  order    Int    @default(0)

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@map("room_images")
}

model Booking {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  hotelId       String        @map("hotel_id")
  roomId        String        @map("room_id")
  checkIn       DateTime      @map("check_in") @db.Date
  checkOut      DateTime      @map("check_out") @db.Date
  guests        Int
  roomsCount    Int           @map("rooms_count")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(10, 2)
  status        BookingStatus @default(pending_payment)
  paymentStatus PaymentStatus @default(pending) @map("payment_status")
  guestName     String        @map("guest_name") @db.VarChar(100)
  guestEmail    String        @map("guest_email") @db.VarChar(255)
  guestPhone    String        @map("guest_phone") @db.VarChar(20)
  specialNotes  String?       @map("special_notes") @db.Text
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hotel    Hotel     @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  room     Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([hotelId])
  @@index([roomId])
  @@index([status])
  @@index([checkIn])
  @@index([checkOut])
  @@index([createdAt])
  @@map("bookings")
}

model Payment {
  id          String          @id @default(uuid())
  bookingId   String          @map("booking_id")
  provider    PaymentProvider
  providerRef String?         @map("provider_ref") @db.VarChar(255)
  amount      Decimal         @db.Decimal(10, 2)
  currency    String          @default("USD") @db.VarChar(3)
  status      PaymentStatus   @default(pending)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  hotelId   String   @map("hotel_id")
  rating    Int
  comment   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  hotel Hotel @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  @@unique([userId, hotelId])
  @@index([hotelId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}
